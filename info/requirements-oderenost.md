# Требования: Учет доверенностей при голосовании

## Таблица требований

| # | Требование | Описание | Статус | Коммит | Важные детали |
|---|------------|----------|--------|--------|---------------|
| 1 | Умножение голоса на количество доверенностей | Когда пользователь голосует и у него есть доверенности от других участников заседания, его голос должен умножаться на (1 + количество доверенностей). Например: пользователь 10 получил доверенности от 40, 41, 12, 39 (всего 4 доверенности). Когда он голосует "За", должно засчитываться +5 голосов (его голос + 4 доверенности). | В работе | - | - Доверенности привязаны к конкретному заседанию (meetingId)<br>- Один пользователь может передать доверенность только одному человеку в рамках заседания<br>- Один пользователь может получить множество доверенностей<br>- Уже существует логика подсчета voteWeight в `/api/vote-by-result`<br>- Текущий подсчет: weight = 1 + количество полученных доверенностей |
| 2 | Увеличение голосов в реальном времени | При голосовании через веб-интерфейс или Televic, счетчики "За", "Против", "Воздержались" должны сразу увеличиваться на величину веса голоса (1 + доверенности) | Не начато | - | - Проверить работу с Socket.IO событиями<br>- Проверить интеграцию с Televic CoCon Connector<br>- Обновление происходит через `connector:voting:results` event |
| 3 | Отображение в PDF отчетах | В PDF отчетах (VoteResultsPDF и DetailedVoteResultsPDF) должно отображаться:<br>- Итоговые числа с учетом доверенностей<br>- Для открытых голосований: указание рядом с пользователем количества доверенностей<br>Пример: "10 (Сайт) - За (вес: 5, доверенности от: 40, 41, 12, 39)" | Не начато | - | - Файлы: `/src/components/VoteResultsPDF.jsx`, `/src/components/DetailedVoteResultsPDF.jsx`<br>- Нужно добавить информацию о полученных доверенностях в детальные списки<br>- Сохранить читаемость отчетов |
| 4 | Отображение веса голоса в интерфейсе | В админ-панели управления заседанием показывать вес голоса каждого участника | Не начато | - | - В ControlMeetingPage.jsx уже есть информация о receivedProxies<br>- Добавить колонку "Вес голоса" в таблицу участников<br>- Показывать кто передал доверенности (tooltip или список) |
| 5 | Обновление подсчета кворума | Уточнить как доверенности влияют на кворум:<br>- Считать ли пользователей, передавших доверенность, как присутствующих?<br>- Считать ли вес доверенностей при подсчете кворума? | Ожидает уточнения | - | - Текущая логика в quorum.js: настройка countProxies определяет учет<br>- Типы кворума: MORE_THAN_ONE, TWO_THIRDS_OF_TOTAL, HALF_PLUS_ONE<br>- Необходимо согласовать с требованиями |

## Архитектурные детали

### Текущая реализация voteWeight

**Место**: `/var/www/hmau-vote/api/root/vote.cjs` (строки 421-431)

```javascript
// Подсчитываем вес каждого голоса (свой + доверенности)
const voteWeights = new Map();
votes.forEach(v => {
  const weight = 1 + proxies.filter(p => p.toUserId === v.userId).length;
  voteWeights.set(v.userId, weight);
});

const votesFor = votes.filter(v => v.choice === 'FOR')
  .reduce((sum, v) => sum + (voteWeights.get(v.userId) || 1), 0);
const votesAgainst = votes.filter(v => v.choice === 'AGAINST')
  .reduce((sum, v) => sum + (voteWeights.get(v.userId) || 1), 0);
const votesAbstain = votes.filter(v => v.choice === 'ABSTAIN')
  .reduce((sum, v) => sum + (voteWeights.get(v.userId) || 1), 0);
```

**Статус**: Логика уже реализована! Нужно проверить работу и возможно исправить баги.

### Структура таблицы Proxy

**Файл**: `/var/www/hmau-vote/prisma/schema.prisma`

```prisma
model Proxy {
  id         Int      @id @default(autoincrement())
  meetingId  Int
  meeting    Meeting  @relation(fields: [meetingId], references: [id], onDelete: Cascade)
  fromUserId Int      // Кто передал доверенность
  fromUser   User     @relation("ProxyFrom", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUserId   Int      // Кому передали доверенность
  toUser     User     @relation("ProxyTo", fields: [toUserId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([meetingId, fromUserId]) // Один пользователь может передать только ОДНУ доверенность
  @@index([meetingId, toUserId])
}
```

### API endpoints

| Endpoint | Метод | Описание |
|----------|-------|----------|
| `/api/meetings/:id/participants` | GET | Возвращает участников с полями `voteWeight`, `receivedProxies`, `proxy` |
| `/api/meetings/:id/vote-weight/:userId` | GET | Возвращает вес голоса конкретного пользователя |
| `/api/meetings/:id/participants/save` | POST | Сохраняет доверенности для заседания |
| `/api/vote-by-result` | POST | Записывает голос и пересчитывает результаты с учетом весов |

### Критические места для проверки

1. **Socket.IO события** (`/api/server.cjs`):
   - `connector:voting:results` - обновление результатов от Televic
   - Нужно проверить что обновление учитывает voteWeight

2. **Televic интеграция** (`/api/root/televic.cjs`):
   - Голоса от Televic должны учитывать доверенности
   - Проверить связь televicExternalId с userId

3. **PDF отчеты**:
   - `VoteResultsPDF.jsx` - сводная таблица
   - `DetailedVoteResultsPDF.jsx` - детальные результаты
   - Нужно добавить информацию о весе голоса

## Уточненные требования (ответы пользователя)

1. **Отображение в детальных результатах**:
   - ✅ Показывать один голос с весом 5: "10 (Сайт) - За (вес: 5)"
   - НЕ показывать 5 отдельных записей

2. **Экран голосования в реальном времени**:
   - ✅ Счетчик должен СРАЗУ показывать +5 (не +1)

3. **PDF отчеты**:
   - ✅ "10 (Сайт) проголосовал За (с доверенностями от: 40, 41, 12, 39)"
   - Отображать имена тех, кто передал доверенности

4. **Televic голосование**:
   - ✅ Голос через Televic УМНОЖАЕТСЯ на доверенности
   - Используется televicExternalId для сопоставления

5. **Кворум**:
   - ✅ Если пришло 10 человек, у одного 4 доверенности = кворум считается как 14
   - Доверенности увеличивают кворум

6. **Те кто передали доверенность**:
   - ✅ Пользователи 40, 41, 12, 39 НЕ могут голосовать независимо
   - Их голоса автоматически считаются через пользователя 10
   - Они НЕ должны видеть кнопки голосования или их голоса должны блокироваться

## План реализации

### Этап 1: Проверка текущей логики
- [x] Изучить код подсчета голосов в `/api/vote-by-result`
- [ ] Протестировать текущую работу voteWeight
- [ ] Проверить что голоса умножаются правильно

### Этап 2: Исправление багов (если есть)
- [ ] Проверить работу с Socket.IO событиями
- [ ] Проверить интеграцию с Televic
- [ ] Исправить подсчет если не работает

### Этап 3: Отображение в интерфейсах
- [ ] Добавить вес голоса в список участников
- [ ] Обновить PDF отчеты
- [ ] Показать доверенности в детальных результатах

### Этап 4: Тестирование
- [ ] Создать тестовое заседание
- [ ] Настроить доверенности (4 человека -> пользователь 10)
- [ ] Проголосовать и проверить результаты
- [ ] Сгенерировать PDF и проверить отчеты

## Тестовый сценарий

**Заседание 125**: https://rms-bot.com/hmau-vote/console/meeting/125

**Пользователь 10**:
- Получил доверенности от: 40, 41, 12, 39 (всего 4 доверенности)
- Вес голоса должен быть: 1 + 4 = 5

**Ожидаемое поведение**:
1. Пользователь 10 голосует "За"
2. Счетчик "За" увеличивается на +5
3. В детальных результатах показывается вес 5
4. В PDF отчете отображается информация о доверенностях

**Текущее поведение** (нужно проверить):
- ?

## Связанные файлы

### Backend (API)
- `/var/www/hmau-vote/api/root/vote.cjs` - подсчет голосов
- `/var/www/hmau-vote/api/root/meetings.cjs` - получение участников и voteWeight
- `/var/www/hmau-vote/api/server.cjs` - Socket.IO события
- `/var/www/hmau-vote/api/root/televic.cjs` - интеграция Televic

### Frontend
- `/var/www/hmau-vote/src/pages/ControlMeetingPage.jsx` - админ-панель заседания
- `/var/www/hmau-vote/src/components/VoteResultsPDF.jsx` - сводные результаты PDF
- `/var/www/hmau-vote/src/components/DetailedVoteResultsPDF.jsx` - детальные результаты PDF
- `/var/www/hmau-vote/src/pages/MeetingScreenPage.jsx` - экран голосования

### Database
- `/var/www/hmau-vote/prisma/schema.prisma` - модель Proxy
