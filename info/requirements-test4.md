# Требования к системе голосования HMAU - Часть 4 (Тестирование)

<style>
table {
  border-collapse: collapse;
  width: 100%;
}
th, td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
th {
  background-color: #f2f2f2;
}
</style>

## Оглавление

1. [API для управления тестовыми пользователями](#api-для-управления-тестовыми-пользователями)

---

## Таблица требований

| # | Требования | Описание | Статус | Коммит | Важные детали |
|---|-----------|----------|--------|--------|---------------|
| 1 | API для создания тестовых пользователей | Создание 38 тестовых пользователей с ID от 10 до 47 одним запросом | ✅ | PENDING | **Проблема**: Для тестирования системы голосования нужен быстрый способ создать множество тестовых пользователей с предсказуемыми данными. **Решение**: Создан API endpoint POST /api/test/create-users который создает 38 пользователей с паттерном: Имя="10", Email="10@10.ru", Логин="10", Пароль="123" и так далее до ID 47. Все пользователи добавляются в тестовую группу "Тестовая группа 10". **Затронутые файлы**: api/root/test.cjs (создан новый файл), prisma/schema.prisma:24 (добавлено поле username). **Curl команда**: `curl -X POST https://rms-bot.com/api/test/create-users -H "Content-Type: application/json" -d '{}'` **Параметры (опциональные)**: count=38 (количество пользователей), startId=10 (начальный ID), divisionName="Тестовая группа 10" (название группы), password="123" (пароль). **Результат**: ✅ Создает 38 пользователей (10-47) ✅ Автоматически создает группу если не существует ✅ Пропускает существующих пользователей ✅ Возвращает список созданных пользователей |
| 2 | API для удаления тестовых пользователей | Удаление всех тестовых пользователей и опционально тестовой группы | ✅ | PENDING | **Проблема**: После тестирования нужно быстро очистить базу от тестовых данных. **Решение**: Создан API endpoint DELETE /api/test/delete-users который удаляет пользователей по username (10-47). Может опционально удалить тестовую группу если в ней не осталось пользователей. **Затронутые файлы**: api/root/test.cjs:152-226. **Curl команда**: `curl -X DELETE https://rms-bot.com/api/test/delete-users -H "Content-Type: application/json" -d '{"deleteDivision": true}'` **Параметры (опциональные)**: startId=10, count=38, divisionName="Тестовая группа 10", deleteDivision=true/false. **Результат**: ✅ Удаляет всех указанных пользователей ✅ Опционально удаляет пустую группу ✅ Безопасно - группа не удаляется если есть другие пользователи ✅ Возвращает количество удаленных пользователей |
| 3 | API для подсчета тестовых пользователей | Проверка количества созданных тестовых пользователей | ✅ | PENDING | **Проблема**: Нужен способ проверить, сколько тестовых пользователей создано в системе перед тестированием. **Решение**: Создан API endpoint GET /api/test/count-users который находит и считает пользователей с username 10-47. **Затронутые файлы**: api/root/test.cjs:236-284. **Curl команда**: `curl https://rms-bot.com/api/test/count-users` **Параметры (опциональные)**: startId=10, count=38. **Результат**: ✅ Возвращает found (найдено) и expected (ожидается) ✅ Показывает детали каждого пользователя ✅ Включает информацию о группе |
| 4 | Исправление Prisma схемы - добавление поля username | Поле username отсутствовало в Prisma schema хотя присутствует в БД | ✅ | PENDING | **Проблема**: При вызове create-users API возникала ошибка "Unknown argument `username`". Prisma Client не знал о поле username, хотя оно существовало в базе данных PostgreSQL. **Причина**: В файле prisma/schema.prisma модель User не содержала поле username. При генерации Prisma Client это поле не попадало в типы. **Решение**: Добавлено поле `username String? @unique // Логин пользователя` в модель User после поля divisionId (строка 24). Выполнен npx prisma generate для регенерации Prisma Client. PM2 перезапущен для загрузки нового клиента. **Затронутые файлы**: prisma/schema.prisma:24 (добавлено поле username). **Результат**: ✅ Prisma Client корректно распознает поле username ✅ API создания пользователей работает без ошибок ✅ Можно создавать и искать пользователей по username ✅ Индекс и UNIQUE constraint сохранены |
|   |           |          |        |        |               |

---

## Примеры использования

### 1. Создание тестовых пользователей

**Создать 38 пользователей (по умолчанию):**
```bash
curl -X POST https://rms-bot.com/api/test/create-users \
  -H "Content-Type: application/json" \
  -d '{}'
```

**Создать 5 пользователей с ID от 100:**
```bash
curl -X POST https://rms-bot.com/api/test/create-users \
  -H "Content-Type: application/json" \
  -d '{"count": 5, "startId": 100}'
```

**Создать пользователей в другую группу:**
```bash
curl -X POST https://rms-bot.com/api/test/create-users \
  -H "Content-Type: application/json" \
  -d '{"divisionName": "Моя тестовая группа", "password": "test123"}'
```

**Пример успешного ответа:**
```json
{
  "success": true,
  "message": "Created 38 test users",
  "division": {
    "id": 36,
    "name": "Тестовая группа 10"
  },
  "created": 38,
  "skipped": 0,
  "total": 38,
  "users": [
    {
      "id": 39,
      "name": "10",
      "email": "10@10.ru",
      "username": "10"
    },
    ...
  ]
}
```

---

### 2. Проверка созданных пользователей

**Подсчитать пользователей с ID 10-47:**
```bash
curl https://rms-bot.com/api/test/count-users
```

**Подсчитать пользователей с другим диапазоном:**
```bash
curl 'https://rms-bot.com/api/test/count-users?startId=100&count=5'
```

**Пример ответа:**
```json
{
  "success": true,
  "found": 38,
  "expected": 38,
  "users": [
    {
      "id": 55,
      "username": "26",
      "email": "26@10.ru",
      "name": "26",
      "divisionId": 36,
      "division": {
        "id": 36,
        "name": "Тестовая группа 10"
      }
    },
    ...
  ]
}
```

---

### 3. Удаление тестовых пользователей

**Удалить пользователей БЕЗ удаления группы:**
```bash
curl -X DELETE https://rms-bot.com/api/test/delete-users \
  -H "Content-Type: application/json" \
  -d '{}'
```

**Удалить пользователей И группу:**
```bash
curl -X DELETE https://rms-bot.com/api/test/delete-users \
  -H "Content-Type: application/json" \
  -d '{"deleteDivision": true}'
```

**Удалить пользователей с другим диапазоном:**
```bash
curl -X DELETE https://rms-bot.com/api/test/delete-users \
  -H "Content-Type: application/json" \
  -d '{"startId": 100, "count": 5, "deleteDivision": true}'
```

**Пример ответа:**
```json
{
  "success": true,
  "message": "Deleted 38 test users",
  "deleted": 38,
  "divisionDeleted": true,
  "divisionName": "Тестовая группа 10"
}
```

---

## Паттерн тестовых данных

При создании пользователей используется следующий паттерн:

| Поле | Значение | Пример (startId=10) |
|------|----------|---------------------|
| Имя (name) | `{ID}` | "10", "11", "12", ... "47" |
| Email | `{ID}@10.ru` | "10@10.ru", "11@10.ru", ... "47@10.ru" |
| Логин (username) | `{ID}` | "10", "11", "12", ... "47" |
| Пароль | `123` (по умолчанию) | "123" (для всех) |
| Группа | "Тестовая группа 10" | Одна группа для всех |
| isAdmin | `false` | Обычные пользователи |
| isOnline | `false` | Не в сети |

**Диапазон ID**: По умолчанию создаются пользователи с ID от **10** до **47** (38 штук).

---

## Обработка ошибок

### Дубликаты пользователей

Если пользователь с таким email или username уже существует, он будет **пропущен** (не вызовет ошибку):

```json
{
  "success": true,
  "message": "Created 0 test users",
  "created": 0,
  "skipped": 5,
  "total": 5,
  "errors": [
    {
      "userId": 100,
      "email": "100@10.ru",
      "username": "100",
      "error": "User already exists"
    }
  ]
}
```

### Безопасность удаления группы

Группа будет удалена ТОЛЬКО если:
1. Параметр `deleteDivision: true` указан явно
2. В группе НЕ осталось других пользователей

Это предотвращает случайное удаление групп с реальными пользователями.

---

## Легенда статусов

- ✅ **Выполнено** - функционал реализован и протестирован
- ⏳ **В работе** - функционал в процессе разработки
- 📋 **Запланировано** - требование добавлено в бэклог
- ❌ **Отменено** - требование отменено или заменено другим
- 🐛 **Исправление бага** - исправление найденной проблемы

---

## Как добавлять новые требования

Чтобы добавить новую строку в таблицу, просто скопируйте эту строку и заполните:

```markdown
| 5 | Название требования | Описание функционала | ✅ | abc1234 | Важные детали |
```

**Где добавлять:** Вставьте новую строку после последней заполненной строки (перед пустыми строками).

**Пример:**
```markdown
| 4 | Существующее требование | ... | ✅ | ... | ... |
| 5 | НОВОЕ требование | Описание | 📋 | - | Детали |  ← ДОБАВИТЬ ЗДЕСЬ
|   |           |          |        |        |               |
```

**Доступные статусы:**
- ✅ Выполнено
- ⏳ В работе
- 📋 Запланировано
- ❌ Отменено
- 🐛 Исправление бага

---

*Последнее обновление: 2025-10-16*
