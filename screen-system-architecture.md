# Архитектура системы экранов трансляции

## Общая концепция

Система управления экранами трансляции для мероприятий с возможностью настройки интерфейса каждого типа экрана.

## 4 типа экранов

### 1. Экран регистрации
**Когда показывается**: До начала заседания (status = 'WAITING')
**Что отображается**:
- Название заседания
- Время начала
- Список зарегистрированных участников (онлайн)
- Счетчик: "Зарегистрировано: X из Y"
- Возможно: логотип, фоновое изображение

### 2. Экран активной повестки
**Когда показывается**: Заседание идет (status = 'IN_PROGRESS'), но голосования нет
**Что отображается**:
- Текущий вопрос повестки (activeIssue = true)
- Докладчик
- Полная повестка с подсветкой активного вопроса
- Возможно: таймер выступления

### 3. Экран голосования
**Когда показывается**: Идет активное голосование (voteStatus = 'PENDING')
**Что отображается**:
- Вопрос голосования
- Таймер обратного отсчета
- Результаты в реальном времени:
  - За: X
  - Против: Y
  - Воздержались: Z
  - Не проголосовали: W
- Прогресс-бар голосования
- Возможно: графики, диаграммы

### 4. Финальный экран (итоги)
**Когда показывается**:
- Голосование завершено (voteStatus = 'ENDED' или 'APPLIED')
- Или заседание завершено (status = 'COMPLETED')
**Что отображается**:
- Итоги последнего голосования
- Решение: "Принято" / "Не принято"
- Финальные цифры
- Возможно: итоги всех голосований заседания

## Структура базы данных

### Новая таблица: ScreenConfig
```prisma
model ScreenConfig {
  id        Int      @id @default(autoincrement())
  type      ScreenType // REGISTRATION, AGENDA, VOTING, FINAL
  config    Json     // Настройки интерфейса (цвета, размеры, позиции элементов)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ScreenType {
  REGISTRATION
  AGENDA
  VOTING
  FINAL
}
```

### Структура config (JSON):
```json
{
  "backgroundColor": "#ffffff",
  "headerColor": "#1976d2",
  "titleFontSize": "48px",
  "showLogo": true,
  "logoPosition": "top-left",
  "showParticipants": true,
  "participantsPosition": "right",
  "customCSS": "...",
  "elements": [
    {
      "type": "title",
      "x": 100,
      "y": 50,
      "fontSize": "48px",
      "color": "#000"
    },
    {
      "type": "timer",
      "x": 500,
      "y": 200,
      "fontSize": "72px",
      "color": "#d32f2f"
    }
  ]
}
```

## Страницы системы

### 1. Страница конфигурации: `/hmau-vote/screen`
**Компонент**: `ScreenPage.jsx` (переделать)
**Функционал**:
- 4 карточки (квадратика) для каждого типа экрана
- Превью текущей конфигурации
- Кнопка "Редактировать" → открывает `/hmau-vote/screen/edit/{type}`

### 2. Страницы редакторов: `/hmau-vote/screen/edit/:type`
**Новые компоненты**:
- `ScreenEditorPage.jsx` (общий редактор)
- `RegistrationScreenEditor.jsx`
- `AgendaScreenEditor.jsx`
- `VotingScreenEditor.jsx`
- `FinalScreenEditor.jsx`

**Функционал редактора**:
- Левая панель: список элементов (drag-and-drop)
- Центр: превью экрана в реальном времени
- Правая панель: настройки выбранного элемента
- Кнопки: "Сохранить", "Отмена", "Сбросить к умолчанию"

### 3. Страница трансляции: `/hmau-vote/console/meeting/:id/screen`
**Компонент**: `MeetingScreenPage.jsx` (переделать)
**Функционал**:
- Определяет текущее состояние заседания
- Загружает соответствующую конфигурацию из БД
- Отображает нужный экран с настроенным интерфейсом
- Обновляется в реальном времени через Socket.IO

## Логика переключения экранов

```javascript
function determineScreenType(meeting, activeVote) {
  // 1. Если есть активное голосование
  if (activeVote && activeVote.voteStatus === 'PENDING') {
    return 'VOTING';
  }

  // 2. Если голосование только что завершилось
  if (activeVote && (activeVote.voteStatus === 'ENDED' || activeVote.voteStatus === 'APPLIED')) {
    return 'FINAL';
  }

  // 3. Если заседание завершено
  if (meeting.status === 'COMPLETED') {
    return 'FINAL';
  }

  // 4. Если заседание идет
  if (meeting.status === 'IN_PROGRESS') {
    return 'AGENDA';
  }

  // 5. Если заседание еще не началось
  if (meeting.status === 'WAITING') {
    return 'REGISTRATION';
  }

  return 'REGISTRATION'; // По умолчанию
}
```

## API Endpoints

### GET /api/screen-configs
Получить все конфигурации экранов

### GET /api/screen-configs/:type
Получить конфигурацию конкретного типа экрана

### PUT /api/screen-configs/:type
Обновить конфигурацию экрана
Body: `{ config: {...} }`

### POST /api/screen-configs/reset/:type
Сбросить конфигурацию к значениям по умолчанию

## Поэтапный план реализации

### Фаза 1: Основа (сейчас)
1. ✅ Изучить текущую реализацию
2. ⏳ Создать схему БД (миграция Prisma)
3. ⏳ Создать API endpoints
4. ⏳ Переделать `/hmau-vote/screen` на страницу с 4 квадратиками

### Фаза 2: Редакторы (потом)
5. Создать базовый редактор с превью
6. Реализовать сохранение конфигураций
7. Добавить настройки для каждого типа экрана

### Фаза 3: Трансляция (финал)
8. Переделать `MeetingScreenPage` для динамического отображения
9. Реализовать автоматическое переключение экранов
10. Добавить красивые переходы между экранами

## Преимущества архитектуры

1. **Гибкость**: Каждый экран настраивается независимо
2. **Масштабируемость**: Легко добавить новые типы экранов
3. **Переиспользование**: Одна конфигурация для всех заседаний
4. **Реал-тайм**: Socket.IO обеспечивает мгновенные обновления
5. **UX**: Визуальный редактор без программирования

## Технологии

- **Frontend**: React 19, drag-and-drop библиотека (react-dnd)
- **Backend**: Express, Prisma, PostgreSQL
- **Real-time**: Socket.IO
- **Styling**: CSS-in-JS или Tailwind для динамических стилей
