# Заметки по проекту HMAU Vote - интеграция с Televic CoCon

## Ключевые моменты архитектуры

### 1. Два проекта на одной базе PostgreSQL
- `/var/www/hmau-vote` - основной проект (новый)
- `/var/www/voting-app` - старый проект
- **ВАЖНО**: Оба используют одну БД `voting` на localhost:5432
- Пароль postgres: `postgres`
- Пользователь БД: `votingapp` (используется в проекте voting-app)

### 2. Порты и nginx
- **voting-api работает на порту 5000** (НЕ 3000!)
- Порт 3000 занят процессом `roma-bot` (PID 582110)
- nginx проксирует `/api/` на `http://127.0.0.1:5000` (правильно настроено)
- Конфиг nginx: `/etc/nginx/sites-available/agents` строки 99-100

### 3. PM2 процессы
- `pm2 list` - основной процесс `voting-api` (ID 20)
- Перезапуск: `pm2 restart voting-api`
- Логи: `pm2 logs voting-api`

### 4. Prisma схема
- Файл: `/var/www/hmau-vote/prisma/schema.prisma`
- После изменений ВСЕГДА: `npx prisma generate`
- Миграции: `npx prisma migrate dev`
- **ВАЖНО**: Поле `AgendaItem.speakerName` уже есть в БД, но было добавлено позже

### 5. Проблема с авторизацией
- **Фронтенд отправляет `username` вместо `email`**
- Исправлено в `/var/www/hmau-vote/api/root/auth.cjs:46`
- Код: `const email = req.body.email || req.body.username;`

## Интеграция с Televic CoCon

### Архитектура
```
Веб-сайт (cloud)
  ↓ Socket.IO namespace: /cocon-connector
Коннектор на ПК (Windows)
  ↓ HTTP REST API
Televic CoCon система (localhost:8890)
```

### Коннектор на ПК
- Путь: `/var/www/PC-vercion-Out-app-cocon-node/`
- **На сервере это архив, на ПК пользователя это работающее приложение**
- После изменений: скопировать файлы на ПК и перезапустить коннектор

### Ключевые файлы коннектора
1. `src/backend/coconClient.js` - клиент для CoCon API
2. `src/backend/commandHandlers.js` - обработчики команд от сервера
3. `src/backend/socketClient.js` - Socket.IO подключение к серверу

### Реализованные команды

#### 1. Создание заседания
- Команда: `CreateAgenda`
- Файл: `api/root/televic.cjs:87-120`

#### 2. Добавление вопроса повестки
- Команда: `AddQuestionInAgenda`
- Файл: `api/root/agenda-items.cjs:100-136`
- **ВАЖНО**: CoCon требует последовательные ID (1, 2, 3...) без пропусков!
- Коннектор автоматически получает текущие вопросы и использует следующий ID

#### 3. Активация вопроса повестки
- Команда: `SetCurrentQuestionInAgenda`
- Файл: `api/root/agenda-items.cjs:167-198`
- Срабатывает когда `activeIssue = true`

#### 4. Запуск голосования (НОВОЕ)
- Команда: `StartVotingWithTemplate`
- Файл сервера: `api/root/vote.cjs:774-805`
- Файл коннектора: `src/backend/coconClient.js:218-296`

### Как работает голосование

**На сервере (vote.cjs):**
```javascript
// При POST /api/start-vote
// 1. Создается VoteResult со статусом PENDING
// 2. Отправляется команда StartVotingWithTemplate в коннектор:
{
  agendaItemNumber: 1,
  votingTitle: "За принятие повестки №1",
  voteType: "OPEN", // или "CLOSED"
  duration: 60 // секунды
}
```

**В коннекторе (coconClient.js:218-296):**
```javascript
// 1. Устанавливает активный вопрос: SetActiveAgendaItemById
// 2. Создает динамический шаблон голосования: AddVotingTemplate
//    - Title = название голосования (показывается делегатам!)
//    - 3 опции: За (Green), Против (Red), Воздержался (Yellow)
//    - OverallOption: OPEN=4 (все видят), CLOSED=1 (никто не видит)
//    - EnableVotingTimer=true, Duration=XX:XX:XX
// 3. Запускает голосование: SetVotingState/?State=Start
```

### CoCon API особенности

**Базовый URL:** `http://localhost:8890/CoCon`

**Ключевые endpoints:**
- `/Meeting_Agenda/AddAgendaItem` - добавить вопрос (параметры: Title, Des, Sequence, Type)
- `/Meeting_Agenda/SetActiveAgendaItemById` - активировать вопрос
- `/Voting/AddVotingTemplate` - создать шаблон (очень много параметров!)
- `/Voting/SetVotingState/?State=Start` - управление голосованием
- `/Voting/GetGeneralVotingResults/?Id=X` - получить результаты

**Документация:** `/var/www/PC-vercion-Out-app-cocon-node/API Document for 6.10.md`

## Текущие проблемы

### 1. Отсутствующие endpoints (404)
- `/api/duration-templates` - НЕ РЕАЛИЗОВАН
- `/api/meetings/:id/queue/QUESTION` - НЕ РЕАЛИЗОВАН
- `/api/meetings/:id/queue/SPEECH` - НЕ РЕАЛИЗОВАН

**Решение:** Создать эти endpoints или обойтись без них (можно вводить время вручную)

### 2. flatpickr is not defined
- Проблема в файле `main.js:124`
- Библиотека для выбора даты/времени не подключена
- Это проблема фронтенда, не критично для API

### 3. WebSocket connection failed
- Socket.IO периодически падает
- Проверить: `pm2 logs voting-api | grep socket`

## TODO - Завершение интеграции голосования

### Осталось сделать:

1. **Остановка голосования в CoCon когда таймер истекает**
   - Файл: `api/root/vote.cjs` строка ~807 (setTimeout)
   - Добавить отправку команды `SetVotingState/?State=Stop`

2. **Получение результатов из CoCon**
   - API: `/Voting/GetIndividualVotingResults/?Id=X`
   - Сохранить кто как проголосовал в БД

3. **Создать недостающие endpoints (опционально)**
   - `/api/duration-templates` - GET список шаблонов времени
   - `/api/meetings/:id/queue/*` - GET очередь на выступление

## Полезные команды

```bash
# Перезапуск API
pm2 restart voting-api

# Логи в реальном времени
pm2 logs voting-api --lines 100

# Регенерация Prisma клиента
cd /var/www/hmau-vote && npx prisma generate

# Проверка порта
lsof -i :5000

# Тест API напрямую (без nginx)
curl http://localhost:5000/api/health

# Тест через nginx
curl https://rms-bot.com/api/health

# Проверка БД
PGPASSWORD=postgres psql -U postgres -d voting -h localhost -c "SELECT * FROM \"Meeting\" LIMIT 1;"
```

## Коммиты

### Последний коммит с интеграцией голосования
```
7bb531f - Add CoCon voting integration - start voting in Televic system
```

### Что включает:
- Модифицирован `api/root/vote.cjs` - добавлен параметр `io`, отправка команды
- Модифицирован `api/server.cjs` - передача `io` в vote router
- Коннектор: добавлен `StartVotingWithTemplate` command handler
- Коннектор: добавлен метод `startVotingWithTemplate()` в coconClient.js

## Важные замечания

1. **ВСЕГДА тестировать через nginx (https://rms-bot.com), НЕ напрямую через порт**
2. **Коннектор должен быть запущен на ПК пользователя для работы интеграции**
3. **Проверять `pm2 logs` после каждого изменения**
4. **После изменений в Prisma схеме - обязательно `npx prisma generate`**
5. **Фронтенд и бэкенд могут использовать разные названия полей (username vs email)**
